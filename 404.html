<!DOCTYPE html>
<html lang="en">
<head>
</head>
<body>

<header>
	<h1>404</h1>
	<p>Page not found</p>
</header>

<section>
	<p>Sorry, this page doesn't appear to exist yet.</p>
</section>

<script>

/**
 * Redirect
 * @param {string} folder is a folder name where contents might exist
 * @param {array} extensions contains all extensions to try
 * @returns {object} a new GitDown object
 */
 class Redirect {
    
    constructor(folder, extensions) {
		this.folder = folder;
		this.file = window.location.pathname.split('/').pop();
        this.init(extensions);
    }

	log(msg) {
		console.log(msg);
	}

	init(extensions) {
		this.log(extensions);
		this.log(this.file);
		const urls = this.prepare_urls(extensions);
		this.log(urls);
		this.get_files(urls);
	}

	// directs the loading process, preparing a list of urls to be used in promise chain
    prepare_urls(extensions) {
        var urls = [];
		extensions.forEach(e => {
			urls.push(`${this.folder}/${this.file}.${e}`);
		});
        return urls;
    }

    // takes a series of urls and tries them until one loads succesfully
    get_files( urls ) {
        if ( urls.length < 1 ) return;
        const url = urls.shift();
        /* PROMISE CHAIN */
        this.get(url).then( (response ) => {
            this.log(`URL successfully loaded: ${url}`);
			// we'll now redirect
			location.href = url;
        }).catch( function(error) {
            this.log(error);
			// continue checking for urls
            this.get_files( urls );
        })
    };

    // promise based get
    get(url) {
        return new Promise( function (resolve, reject) {
            const http = new XMLHttpRequest();
            http.open('GET', url);
            http.onload = function () {
                if ( http.status === 200 ) {
                    resolve(http.response);
                } else {
                    reject( Error(http.status) );
                }
            };
            http.onerror = function () {
                reject( Error("Error with request.") );
            };
            http.send();
        });
    }

    /**
     * Helper function for re-combining url parts
     * @returns {string} url with base, query vars and hash
     */
	uri() {
        let q = this.params.toString();
        if ( q.length > 0 ) q = '?' + q;
        let base = window.location.href.split('?')[0];
        base = base.split('#')[0];
        return base + q + location.hash;
    };
 }

const re = new Redirect( 'pages', ['html', 'md', 'asciidoc'] );

</script>

</body>
</html>
